{
	"name": "df_getAQIForAllStations",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "ds_ceppollutiondataforuntilactivitysink",
						"type": "DatasetReference"
					},
					"name": "pollutiondatacsv"
				},
				{
					"dataset": {
						"referenceName": "ds_ceppollutiondataforuntilactivitysink",
						"type": "DatasetReference"
					},
					"name": "pollutiondatacsvtofilter"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "ds_aqicsvsync",
						"type": "DatasetReference"
					},
					"name": "sinktoexcel"
				}
			],
			"transformations": [
				{
					"name": "pivotpollutanants"
				},
				{
					"name": "selectvalidstationsforaqi"
				},
				{
					"name": "innerjoinfromsourcebystationandcity"
				},
				{
					"name": "selectreleventcolumns"
				},
				{
					"name": "calculatesubindexandcheck"
				},
				{
					"name": "calculateaqi"
				},
				{
					"name": "addnewpollutantid"
				},
				{
					"name": "unionallaqidatatothecurrentsource"
				},
				{
					"name": "selectnecessarycolumns"
				},
				{
					"name": "aggbystationinsource"
				}
			],
			"script": "parameters{\n\tdaysleft as integer\n}\nsource(output(\n\t\tid as string,\n\t\tcountry as string,\n\t\tstate as string,\n\t\tcity as string,\n\t\tstation as string,\n\t\tlast_update as string,\n\t\tpollutant_id as string,\n\t\tpollutant_min as double '000,000,000.000',\n\t\tpollutant_max as double '000,000,000.000',\n\t\tpollutant_avg as double '000,000,000.000',\n\t\tpollutant_unit as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: true,\n\tpurgeFiles: true,\n\twildcardPaths:['FilteredData/Temp/*.csv']) ~> pollutiondatacsv\nsource(output(\n\t\tid as string,\n\t\tcountry as string,\n\t\tstate as string,\n\t\tcity as string,\n\t\tstation as string,\n\t\tlast_update as string,\n\t\tpollutant_id as string,\n\t\tpollutant_min as double '000,000,000.000',\n\t\tpollutant_max as double '000,000,000.000',\n\t\tpollutant_avg as double '000,000,000.000',\n\t\tpollutant_unit as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: true,\n\tpurgeFiles: true,\n\twildcardPaths:['FilteredData/Temp/*.csv']) ~> pollutiondatacsvtofilter\npollutiondatacsvtofilter pivot(groupBy(city,\n\t\tstation),\n\tpivotBy(pollutant_id, ['PM2.5', 'PM10']),\n\tPollutant_ = avg(pollutant_avg),\n\tcolumnNaming: '$N$V',\n\tlateral: true) ~> pivotpollutanants\npivotpollutanants select(mapColumn(\n\t\tcity,\n\t\tstation\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> selectvalidstationsforaqi\nselectvalidstationsforaqi, aggbystationinsource join(selectvalidstationsforaqi@city == aggbystationinsource@city\n\t&& selectvalidstationsforaqi@station == aggbystationinsource@station,\n\tjoinType:'inner',\n\tbroadcast: 'auto')~> innerjoinfromsourcebystationandcity\ninnerjoinfromsourcebystationandcity select(mapColumn(\n\t\tcity = aggbystationinsource@city,\n\t\tstation = aggbystationinsource@station,\n\t\tpollutant_id,\n\t\tpollutant_min,\n\t\tpollutant_max,\n\t\tpollutant_avg\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> selectreleventcolumns\nselectreleventcolumns derive(subindex_avg = iif(upper(pollutant_id) == \"PM10\", \r\n    iif(pollutant_avg > 0, \r\n        iif(pollutant_avg <= 50, pollutant_avg,\r\n            iif(and(pollutant_avg > 50,pollutant_avg <= 100), pollutant_avg, \r\n                iif(and(pollutant_avg > 100, pollutant_avg <=250), 100+(pollutant_avg-100)*100/150, \r\n                    iif(and(pollutant_avg > 250, pollutant_avg <=350), 200+(pollutant_avg-250), \r\n                        iif(and(pollutant_avg > 350, pollutant_avg <=430), 300+(pollutant_avg-350)*(100/80), \r\n                            iif(pollutant_avg > 430, 400+(pollutant_avg-430)*(100/80), toDouble(0))))))), toDouble(0)), \r\niif(upper(pollutant_id) == \"PM2.5\", \r\n    iif(pollutant_avg > 0, \r\n        iif(pollutant_avg <= 30, pollutant_avg * 50 / 30, \r\n            iif(and(pollutant_avg > 30, pollutant_avg <=60), 50+(pollutant_avg-30)*50/30, \r\n                iif(and(pollutant_avg > 60, pollutant_avg <=90), 100+(pollutant_avg-60)*100/30, \r\n                    iif(and(pollutant_avg > 90, pollutant_avg <=120), 200+(pollutant_avg-90)*(100/30), \r\n                        iif(and(pollutant_avg > 120, pollutant_avg > 250), 300+(pollutant_avg-120)*(100/130), \r\n                            iif(pollutant_avg > 250, 400+(pollutant_avg-250)*100/130, toDouble(0))))))), toDouble(0)), \r\niif(upper(pollutant_id) == \"SO2\", \r\n    iif(pollutant_avg > 0, \r\n        iif(pollutant_avg <= 40, pollutant_avg * 50 / 40, \r\n            iif(and(pollutant_avg > 40, pollutant_avg <=80), 50+(pollutant_avg-40)*50/40, \r\n                iif(and(pollutant_avg > 80, pollutant_avg <=380), 100+(pollutant_avg-80)*100/300, \r\n                    iif(and(pollutant_avg > 380, pollutant_avg <=800), 200+(pollutant_avg-380)*(100/420), \r\n                        iif(and(pollutant_avg > 800, pollutant_avg > 1600), 300+(pollutant_avg-800)*(100/800), \r\n                            iif(pollutant_avg > 1600, 400+(pollutant_avg-1600)*100/800, toDouble(0))))))), toDouble(0)), \r\niif(upper(pollutant_id) == \"NO2\", \r\n    iif(pollutant_avg > 0, \r\n        iif(pollutant_avg <= 40, pollutant_avg * 50 / 40, \r\n            iif(and(pollutant_avg > 40, pollutant_avg <=80), 50+(pollutant_avg-40)*50/40, \r\n                iif(and(pollutant_avg > 80, pollutant_avg <=180), 100+(pollutant_avg-80)*100/100, \r\n                    iif(and(pollutant_avg > 180, pollutant_avg <=280), 200+(pollutant_avg-180)*(100/100), \r\n                        iif(and(pollutant_avg > 280, pollutant_avg > 400), 300+(pollutant_avg-280)*(100/120), \r\n                            iif(pollutant_avg > 400, 400+(pollutant_avg-400)*100/120, toDouble(0))))))), toDouble(0)), \r\niif(upper(pollutant_id) == \"CO\", \r\n    iif(pollutant_avg > 0, \r\n        iif(pollutant_avg <= 1, pollutant_avg * 50 / 1, \r\n            iif(and(pollutant_avg > 1, pollutant_avg <=2), 50+(pollutant_avg-1)*50/1, \r\n                iif(and(pollutant_avg > 2, pollutant_avg <=10), 100+(pollutant_avg-2)*100/8, \r\n                    iif(and(pollutant_avg > 10, pollutant_avg <=17), 200+(pollutant_avg-10)*(100/7), \r\n                        iif(and(pollutant_avg > 17, pollutant_avg > 34), 300+(pollutant_avg-17)*(100/17), \r\n                            iif(pollutant_avg > 34, 400+(pollutant_avg-34)*100/17, toDouble(0))))))), toDouble(0)), \r\niif(upper(pollutant_id) == \"OZONE\", \r\n    iif(pollutant_avg > 0, \r\n        iif(pollutant_avg <= 50, pollutant_avg * 50 / 50, \r\n            iif(and(pollutant_avg > 50, pollutant_avg <=100), 50+(pollutant_avg-50)*50/50, \r\n                iif(and(pollutant_avg > 100, pollutant_avg <=168), 100+(pollutant_avg-100)*100/68, \r\n                    iif(and(pollutant_avg > 168, pollutant_avg <=208), 200+(pollutant_avg-168)*(100/40), \r\n                        iif(and(pollutant_avg > 208, pollutant_avg > 748), 300+(pollutant_avg-208)*(100/539), \r\n                            iif(pollutant_avg > 748, 400+(pollutant_avg-400)*100/539, toDouble(0))))))), toDouble(0)), \r\niif(upper(pollutant_id) == \"NH3\", \r\n    iif(pollutant_avg > 0, \r\n        iif(pollutant_avg <= 200, pollutant_avg * 50 / 200, \r\n            iif(and(pollutant_avg > 200, pollutant_avg <=400), 50+(pollutant_avg-200)*50/200, \r\n                iif(and(pollutant_avg > 400, pollutant_avg <=800), 100+(pollutant_avg-400)*100/400, \r\n                    iif(and(pollutant_avg > 800, pollutant_avg <=1200), 200+(pollutant_avg-800)*(100/400), \r\n                        iif(and(pollutant_avg > 1200, pollutant_avg > 1800), 300+(pollutant_avg-1200)*(100/600), \r\n                            iif(pollutant_avg > 1800, 400+(pollutant_avg-1800)*100/600, toDouble(0))))))), toDouble(0)), \r\ntoDouble(0)))))))),\n\t\tcheck_avg = iif(and(pollutant_avg <= 0, isNull(pollutant_avg)), 0, 1),\n\t\tsubindex_min = iif(upper(pollutant_id) == \"PM10\", \r\n    iif(pollutant_min > 0, \r\n        iif(pollutant_min <= 50, pollutant_min,\r\n            iif(and(pollutant_min > 50,pollutant_min <= 100), pollutant_min, \r\n                iif(and(pollutant_min > 100, pollutant_min <=250), 100+(pollutant_min-100)*100/150, \r\n                    iif(and(pollutant_min > 250, pollutant_min <=350), 200+(pollutant_min-250), \r\n                        iif(and(pollutant_min > 350, pollutant_min <=430), 300+(pollutant_min-350)*(100/80), \r\n                            iif(pollutant_min > 430, 400+(pollutant_min-430)*(100/80), toDouble(0))))))), toDouble(0)), \r\niif(upper(pollutant_id) == \"PM2.5\", \r\n    iif(pollutant_min > 0, \r\n        iif(pollutant_min <= 30, pollutant_min * 50 / 30, \r\n            iif(and(pollutant_min > 30, pollutant_min <=60), 50+(pollutant_min-30)*50/30, \r\n                iif(and(pollutant_min > 60, pollutant_min <=90), 100+(pollutant_min-60)*100/30, \r\n                    iif(and(pollutant_min > 90, pollutant_min <=120), 200+(pollutant_min-90)*(100/30), \r\n                        iif(and(pollutant_min > 120, pollutant_min > 250), 300+(pollutant_min-120)*(100/130), \r\n                            iif(pollutant_min > 250, 400+(pollutant_min-250)*100/130, toDouble(0))))))), toDouble(0)), \r\niif(upper(pollutant_id) == \"SO2\", \r\n    iif(pollutant_min > 0, \r\n        iif(pollutant_min <= 40, pollutant_min * 50 / 40, \r\n            iif(and(pollutant_min > 40, pollutant_min <=80), 50+(pollutant_min-40)*50/40, \r\n                iif(and(pollutant_min > 80, pollutant_min <=380), 100+(pollutant_min-80)*100/300, \r\n                    iif(and(pollutant_min > 380, pollutant_min <=800), 200+(pollutant_min-380)*(100/420), \r\n                        iif(and(pollutant_min > 800, pollutant_min > 1600), 300+(pollutant_min-800)*(100/800), \r\n                            iif(pollutant_min > 1600, 400+(pollutant_min-1600)*100/800, toDouble(0))))))), toDouble(0)), \r\niif(upper(pollutant_id) == \"NO2\", \r\n    iif(pollutant_min > 0, \r\n        iif(pollutant_min <= 40, pollutant_min * 50 / 40, \r\n            iif(and(pollutant_min > 40, pollutant_min <=80), 50+(pollutant_min-40)*50/40, \r\n                iif(and(pollutant_min > 80, pollutant_min <=180), 100+(pollutant_min-80)*100/100, \r\n                    iif(and(pollutant_min > 180, pollutant_min <=280), 200+(pollutant_min-180)*(100/100), \r\n                        iif(and(pollutant_min > 280, pollutant_min > 400), 300+(pollutant_min-280)*(100/120), \r\n                            iif(pollutant_min > 400, 400+(pollutant_min-400)*100/120, toDouble(0))))))), toDouble(0)), \r\niif(upper(pollutant_id) == \"CO\", \r\n    iif(pollutant_min > 0, \r\n        iif(pollutant_min <= 1, pollutant_min * 50 / 1, \r\n            iif(and(pollutant_min > 1, pollutant_min <=2), 50+(pollutant_min-1)*50/1, \r\n                iif(and(pollutant_min > 2, pollutant_min <=10), 100+(pollutant_min-2)*100/8, \r\n                    iif(and(pollutant_min > 10, pollutant_min <=17), 200+(pollutant_min-10)*(100/7), \r\n                        iif(and(pollutant_min > 17, pollutant_min > 34), 300+(pollutant_min-17)*(100/17), \r\n                            iif(pollutant_min > 34, 400+(pollutant_min-34)*100/17, toDouble(0))))))), toDouble(0)), \r\niif(upper(pollutant_id) == \"OZONE\", \r\n    iif(pollutant_min > 0, \r\n        iif(pollutant_min <= 50, pollutant_min * 50 / 50, \r\n            iif(and(pollutant_min > 50, pollutant_min <=100), 50+(pollutant_min-50)*50/50, \r\n                iif(and(pollutant_min > 100, pollutant_min <=168), 100+(pollutant_min-100)*100/68, \r\n                    iif(and(pollutant_min > 168, pollutant_min <=208), 200+(pollutant_min-168)*(100/40), \r\n                        iif(and(pollutant_min > 208, pollutant_min > 748), 300+(pollutant_min-208)*(100/539), \r\n                            iif(pollutant_min > 748, 400+(pollutant_min-400)*100/539, toDouble(0))))))), toDouble(0)), \r\niif(upper(pollutant_id) == \"NH3\", \r\n    iif(pollutant_min > 0, \r\n        iif(pollutant_min <= 200, pollutant_min * 50 / 200, \r\n            iif(and(pollutant_min > 200, pollutant_min <=400), 50+(pollutant_min-200)*50/200, \r\n                iif(and(pollutant_min > 400, pollutant_min <=800), 100+(pollutant_min-400)*100/400, \r\n                    iif(and(pollutant_min > 800, pollutant_min <=1200), 200+(pollutant_min-800)*(100/400), \r\n                        iif(and(pollutant_min > 1200, pollutant_min > 1800), 300+(pollutant_min-1200)*(100/600), \r\n                            iif(pollutant_min > 1800, 400+(pollutant_min-1800)*100/600, toDouble(0))))))), toDouble(0)), \r\ntoDouble(0)))))))),\n\t\tcheck_min = iif(and(pollutant_min <= 0, isNull(pollutant_min)), 0, 1),\n\t\tsubindex_max = iif(upper(pollutant_id) == \"PM10\", \r\n    iif(pollutant_max > 0, \r\n        iif(pollutant_max <= 50, pollutant_max,\r\n            iif(and(pollutant_max > 50,pollutant_max <= 100), pollutant_max, \r\n                iif(and(pollutant_max > 100, pollutant_max <=250), 100+(pollutant_max-100)*100/150, \r\n                    iif(and(pollutant_max > 250, pollutant_max <=350), 200+(pollutant_max-250), \r\n                        iif(and(pollutant_max > 350, pollutant_max <=430), 300+(pollutant_max-350)*(100/80), \r\n                            iif(pollutant_max > 430, 400+(pollutant_max-430)*(100/80), toDouble(0))))))), toDouble(0)), \r\niif(upper(pollutant_id) == \"PM2.5\", \r\n    iif(pollutant_max > 0, \r\n        iif(pollutant_max <= 30, pollutant_max * 50 / 30, \r\n            iif(and(pollutant_max > 30, pollutant_max <=60), 50+(pollutant_max-30)*50/30, \r\n                iif(and(pollutant_max > 60, pollutant_max <=90), 100+(pollutant_max-60)*100/30, \r\n                    iif(and(pollutant_max > 90, pollutant_max <=120), 200+(pollutant_max-90)*(100/30), \r\n                        iif(and(pollutant_max > 120, pollutant_max > 250), 300+(pollutant_max-120)*(100/130), \r\n                            iif(pollutant_max > 250, 400+(pollutant_max-250)*100/130, toDouble(0))))))), toDouble(0)), \r\niif(upper(pollutant_id) == \"SO2\", \r\n    iif(pollutant_max > 0, \r\n        iif(pollutant_max <= 40, pollutant_max * 50 / 40, \r\n            iif(and(pollutant_max > 40, pollutant_max <=80), 50+(pollutant_max-40)*50/40, \r\n                iif(and(pollutant_max > 80, pollutant_max <=380), 100+(pollutant_max-80)*100/300, \r\n                    iif(and(pollutant_max > 380, pollutant_max <=800), 200+(pollutant_max-380)*(100/420), \r\n                        iif(and(pollutant_max > 800, pollutant_max > 1600), 300+(pollutant_max-800)*(100/800), \r\n                            iif(pollutant_max > 1600, 400+(pollutant_max-1600)*100/800, toDouble(0))))))), toDouble(0)), \r\niif(upper(pollutant_id) == \"NO2\", \r\n    iif(pollutant_max > 0, \r\n        iif(pollutant_max <= 40, pollutant_max * 50 / 40, \r\n            iif(and(pollutant_max > 40, pollutant_max <=80), 50+(pollutant_max-40)*50/40, \r\n                iif(and(pollutant_max > 80, pollutant_max <=180), 100+(pollutant_max-80)*100/100, \r\n                    iif(and(pollutant_max > 180, pollutant_max <=280), 200+(pollutant_max-180)*(100/100), \r\n                        iif(and(pollutant_max > 280, pollutant_max > 400), 300+(pollutant_max-280)*(100/120), \r\n                            iif(pollutant_max > 400, 400+(pollutant_max-400)*100/120, toDouble(0))))))), toDouble(0)), \r\niif(upper(pollutant_id) == \"CO\", \r\n    iif(pollutant_max > 0, \r\n        iif(pollutant_max <= 1, pollutant_max * 50 / 1, \r\n            iif(and(pollutant_max > 1, pollutant_max <=2), 50+(pollutant_max-1)*50/1, \r\n                iif(and(pollutant_max > 2, pollutant_max <=10), 100+(pollutant_max-2)*100/8, \r\n                    iif(and(pollutant_max > 10, pollutant_max <=17), 200+(pollutant_max-10)*(100/7), \r\n                        iif(and(pollutant_max > 17, pollutant_max > 34), 300+(pollutant_max-17)*(100/17), \r\n                            iif(pollutant_max > 34, 400+(pollutant_max-34)*100/17, toDouble(0))))))), toDouble(0)), \r\niif(upper(pollutant_id) == \"OZONE\", \r\n    iif(pollutant_max > 0, \r\n        iif(pollutant_max <= 50, pollutant_max * 50 / 50, \r\n            iif(and(pollutant_max > 50, pollutant_max <=100), 50+(pollutant_max-50)*50/50, \r\n                iif(and(pollutant_max > 100, pollutant_max <=168), 100+(pollutant_max-100)*100/68, \r\n                    iif(and(pollutant_max > 168, pollutant_max <=208), 200+(pollutant_max-168)*(100/40), \r\n                        iif(and(pollutant_max > 208, pollutant_max > 748), 300+(pollutant_max-208)*(100/539), \r\n                            iif(pollutant_max > 748, 400+(pollutant_max-400)*100/539, toDouble(0))))))), toDouble(0)), \r\niif(upper(pollutant_id) == \"NH3\", \r\n    iif(pollutant_max > 0, \r\n        iif(pollutant_max <= 200, pollutant_max * 50 / 200, \r\n            iif(and(pollutant_max > 200, pollutant_max <=400), 50+(pollutant_max-200)*50/200, \r\n                iif(and(pollutant_max > 400, pollutant_max <=800), 100+(pollutant_max-400)*100/400, \r\n                    iif(and(pollutant_max > 800, pollutant_max <=1200), 200+(pollutant_max-800)*(100/400), \r\n                        iif(and(pollutant_max > 1200, pollutant_max > 1800), 300+(pollutant_max-1200)*(100/600), \r\n                            iif(pollutant_max > 1800, 400+(pollutant_max-1800)*100/600, toDouble(0))))))), toDouble(0)), \r\ntoDouble(0)))))))),\n\t\tcheck_max = iif(and(pollutant_max <= 0, isNull(pollutant_max)), 0, 1)) ~> calculatesubindexandcheck\ncalculatesubindexandcheck aggregate(groupBy(city,\n\t\tstation),\n\tpollutant_avg = round(iif(sum(check_avg) >= 3, max(subindex_avg), toDouble(0)), 2),\n\t\tpollutant_min = round(iif(sum(check_min) >= 3, max(subindex_min), toDouble(0)), 2),\n\t\tpollutant_max = round(iif(sum(check_max) >= 3, max(subindex_max), toDouble(0)), 2)) ~> calculateaqi\ncalculateaqi derive(pollutant_id = \"aqi\") ~> addnewpollutantid\naddnewpollutantid, aggbystationinsource union(byName: true)~> unionallaqidatatothecurrentsource\npollutiondatacsv select(mapColumn(\n\t\tcity,\n\t\tstation,\n\t\tpollutant_id,\n\t\tpollutant_min,\n\t\tpollutant_max,\n\t\tpollutant_avg\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> selectnecessarycolumns\nselectnecessarycolumns aggregate(groupBy(city,\n\t\tstation,\n\t\tpollutant_id),\n\tpollutant_min = min(pollutant_min),\n\t\tpollutant_max = max(pollutant_max),\n\t\tpollutant_avg = avg(pollutant_avg)) ~> aggbystationinsource\nunionallaqidatatothecurrentsource sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tpartitionFileNames:[(concat(\"AQI_\", toString(addDays(currentDate(), $daysleft), \"yyyyMMdd\"), \".csv\"))],\n\tpartitionBy('hash', 1),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> sinktoexcel"
		}
	}
}